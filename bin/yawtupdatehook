#!/bin/bash

YAWT=yawt
BLOGROOT=$PWD

update() {
    STATUSES=$1
    if [[ -n $STATUSES ]]; then
        #echo "Running: $YAWT update \"$STATUSES\" -b $BLOGROOT"
        $YAWT update "$STATUSES" -b $BLOGROOT
    fi
}

hg update

CONTENTROOT=`$YAWT info 'path_to_articles' -b $BLOGROOT`
EXT=`$YAWT info 'ext' -b $BLOGROOT`
METAEXT=`$YAWT info 'meta_ext' -b $BLOGROOT`

STATUSES=$(hg status --change $HG_NODE | grep "^\([AMR]\) $CONTENTROOT/\(.*\)\.\($EXT\|$METAEXT\)$"| sed "s|^\([AMR]\) $CONTENTROOT/\(.*\)\.\(.*\)$|\1 \2|")
update "$STATUSES"

STATUSES=$(hg status --rev $HG_NODE:tip| grep "^\([AMR]\) $CONTENTROOT/\(.*\)\.\($EXT\|$METAEXT\)$"| sed "s|^\([AMR]\) $CONTENTROOT/\(.*\)\.\(.*\)$|\1 \2|")
update "$STATUSES"

exit 0
